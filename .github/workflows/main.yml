name: "ğŸš€ Main Pipeline"

# Comprehensive workflow handling all quality checks and builds
# Designed to eliminate race conditions with proper job dependencies

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# Prevent concurrent runs to eliminate race conditions
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Minimal permissions - grant only what's needed
permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  # Global environment variables
  ASTRO_TELEMETRY_DISABLED: 1
  BUN_VERSION: "latest"

jobs:
  # =============================================================================
  # SETUP JOB - Handles all common setup tasks
  # =============================================================================
  setup:
    name: "ğŸ“¦ Setup & Dependencies"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
      
    steps:
      - name: "ğŸ”„ Checkout Repository"
        uses: actions/checkout@v5
        with:
          # Full history for better analysis
          fetch-depth: 0

      - name: "âš¡ Setup Bun Runtime"
        id: setup
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: "ğŸ’¾ Cache Dependencies"
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: deps-${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/package.json') }}
          restore-keys: |
            deps-${{ runner.os }}-bun-

      - name: "ğŸ“¥ Install Dependencies"
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ” Cache miss - installing dependencies..."
          # Graceful lockfile handling
          if ! bun install --frozen-lockfile 2>/dev/null; then
            echo "âš ï¸ Lockfile out of sync, updating..."
            bun install
          fi

      - name: "âœ… Verify Installation"
        run: |
          echo "ğŸ“Š Dependency Summary:"
          bun --version
          echo "Node modules:" $(ls node_modules | wc -l) "packages"
          echo "ğŸ“¦ Setup completed successfully"

  # =============================================================================
  # QUALITY JOB - All code quality checks (depends on setup)
  # =============================================================================
  quality:
    name: "ğŸ” Code Quality"
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 15
    
    strategy:
      matrix:
        check: ['lint', 'format', 'types', 'spell']
      fail-fast: false
      
    steps:
      - name: "ğŸ”„ Checkout Repository"
        uses: actions/checkout@v5

      - name: "âš¡ Setup Bun Runtime"
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: "ğŸ’¾ Restore Dependencies Cache"
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: deps-${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/package.json') }}
          restore-keys: |
            deps-${{ runner.os }}-bun-

      - name: "ğŸ“¥ Install Dependencies (if cache missed)"
        if: needs.setup.outputs.cache-hit != 'true'
        run: bun install --frozen-lockfile || bun install

      - name: "ğŸ” ESLint Analysis"
        if: matrix.check == 'lint'
        run: |
          echo "ğŸ” Running ESLint analysis..."
          bun run lint
          echo "âœ… ESLint passed"

      - name: "ğŸ¨ Format Check"
        if: matrix.check == 'format'
        run: |
          echo "ğŸ¨ Checking code formatting..."
          if ! bun run format:check; then
            echo "âŒ Code formatting issues found!"
            echo "ğŸ’¡ Fix by running: bun run format"
            exit 1
          fi
          echo "âœ… Code formatting passed"

      - name: "ğŸ”§ TypeScript Check"
        if: matrix.check == 'types'
        run: |
          echo "ğŸ”§ Checking TypeScript types..."
          bun run check
          echo "âœ… TypeScript check passed"

      - name: "ğŸ“ Spell Check"
        if: matrix.check == 'spell'
        uses: streetsidesoftware/cspell-action@v7
        with:
          config: cspell.config.json
          strict: false
          inline: warning

  # =============================================================================
  # BUILD JOB - Build and validation (depends on quality)
  # =============================================================================
  build:
    name: "ğŸ—ï¸ Build & Validate"
    runs-on: ubuntu-latest
    needs: [setup, quality]
    timeout-minutes: 10
    
    steps:
      - name: "ğŸ”„ Checkout Repository"
        uses: actions/checkout@v5

      - name: "âš¡ Setup Bun Runtime"
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: "ğŸ’¾ Restore Dependencies Cache"
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: deps-${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/package.json') }}

      - name: "ğŸ“¥ Install Dependencies (if needed)"
        if: needs.setup.outputs.cache-hit != 'true'
        run: bun install --frozen-lockfile || bun install

      - name: "ğŸ—ï¸ Build Project"
        run: |
          echo "ğŸ—ï¸ Building project for Vercel deployment..."
          bun run build
          
      - name: "âœ… Validate Build Output"
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Build failed: dist folder not created"
            exit 1
          fi
          
          echo "âœ… Build successful - ready for Vercel deployment"
          echo "ğŸ“Š Build Statistics:"
          echo "  ğŸ“ Output directory: dist/"
          echo "  ğŸ“¦ Build size: $(du -sh dist/ | cut -f1)"
          echo "  ğŸ“„ Files created: $(find dist -type f | wc -l)"

      - name: "ğŸ’¾ Cache Build Output"
        uses: actions/cache@v4
        with:
          path: dist/
          key: build-${{ runner.os }}-${{ github.sha }}
          
  # =============================================================================
  # PR WORKFLOW JOB - Handle PR-specific tasks (depends on build)
  # =============================================================================
  pr-workflow:
    name: "ğŸ”€ PR Workflow"
    runs-on: ubuntu-latest
    needs: [setup, quality, build]
    if: github.event_name == 'pull_request'
    timeout-minutes: 5
    
    steps:
      - name: "ğŸ”„ Checkout Repository"
        uses: actions/checkout@v5

      - name: "ğŸ·ï¸ Auto-label PR"
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml

      - name: "ğŸ’¬ Update PR Status"
        uses: actions/github-script@v7
        with:
          script: |
            const statusComment = `## âœ… **Pipeline Completed Successfully!**

            All quality checks and build validation passed. Your code is ready for deployment.

            ### ğŸ“Š **Pipeline Summary:**
            - âœ… **Dependencies** - Installed and cached
            - âœ… **Linting** - ESLint passed
            - âœ… **Formatting** - Code style validated  
            - âœ… **Types** - TypeScript checks passed
            - âœ… **Spelling** - Documentation verified
            - âœ… **Build** - Successfully compiled for Vercel

            ### ğŸš€ **Next Steps:**
            - Vercel will automatically deploy when merged to \`main\`
            - All checks passed - ready for review and merge!
            
            *Pipeline completed in ${{ github.run_number }} â€¢ Commit ${{ github.sha }}*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: statusComment
            });

  # =============================================================================
  # SUMMARY JOB - Final status and cleanup (depends on all)
  # =============================================================================
  summary:
    name: "ğŸ“‹ Pipeline Summary"
    runs-on: ubuntu-latest
    needs: [setup, quality, build]
    if: always()
    timeout-minutes: 2
    
    steps:
      - name: "ğŸ“Š Pipeline Results"
        run: |
          echo "=== ğŸš€ PIPELINE SUMMARY ==="
          echo "Setup Status: ${{ needs.setup.result }}"
          echo "Quality Status: ${{ needs.quality.result }}" 
          echo "Build Status: ${{ needs.build.result }}"
          echo ""
          
          if [[ "${{ needs.setup.result }}" == "success" && 
                "${{ needs.quality.result }}" == "success" && 
                "${{ needs.build.result }}" == "success" ]]; then
            echo "âœ… All pipeline stages completed successfully!"
            echo "ğŸš€ Ready for Vercel deployment"
            exit 0
          else
            echo "âŒ Pipeline failed - check individual job logs"
            exit 1
          fi
